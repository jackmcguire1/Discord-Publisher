import{g as I,h as E,r as d,j as e,C as U,i as S,f as b,k as A,a as k,l as O,z as h,u as R,m as F,n as D,T as w,A as Q,o as q,p as L,q as N,b as M,c as G,s as J,t as P,v as $,w as z,E as V}from"./index-d92f5b56.js";import{u as C,g as _}from"./cdn-c50885ed.js";import{m as T,p as Y}from"./restoreSchema-e35df575.js";import{p as B}from"./index-e4f144c6.js";function H({value:t,onChange:r}){const{data:n}=I(),{data:a,isLoading:m}=E(),l=d.useMemo(()=>a&&a.success&&a.data.find(s=>s.id===t),[a,t]);d.useEffect(()=>{t||r("user")},[t,r]);function f(s){r(s),u(!1)}const[i,u]=d.useState(!1);return d.useEffect(()=>{a!=null&&a.success&&a.data.sort((s,c)=>s.name.localeCompare(c.name))},[a]),e.jsx(U,{onClickOutside:()=>u(!1),children:e.jsxs("div",{className:"px-3 rounded bg-dark-2 relative flex items-center h-12 select-none",children:[e.jsx("div",{onClick:()=>u(s=>!s),role:"button",className:"flex-auto",children:t==="user"&&(n!=null&&n.success)?e.jsxs("div",{className:"flex items-center space-x-2 cursor-pointer w-full",children:[e.jsx("img",{src:C(n.data),className:"guild icon url w-8 h-8 rounded-full flex-none"}),e.jsx("div",{className:"text-lg text-gray-300 flex-auto truncate",children:n.data.name}),e.jsx(S,{className:b("text-white w-5 h-5 flex-none transition-transform",i&&"rotate-180")})]}):l?e.jsxs("div",{className:"flex items-center space-x-2 cursor-pointer w-full",children:[e.jsx("img",{src:_(l),className:"guild icon url w-8 h-8 rounded-full flex-none"}),e.jsx("div",{className:"text-lg text-gray-300 flex-auto truncate",children:l.name}),e.jsx(S,{className:b("text-white w-5 h-5 flex-none transition-transform",i&&"rotate-180")})]}):e.jsx("div",{className:"text-gray-300",children:"Select guild"})}),i&&e.jsxs("div",{className:"absolute bg-dark-2 top-14 left-0 rounded shadow-lg w-full border-2 border-dark-2 z-10",children:[(n==null?void 0:n.success)&&e.jsxs("div",{className:"py-2 flex space-x-2 items-center hover:bg-dark-3 rounded cursor-pointer px-3",role:"button",onClick:()=>f("user"),children:[e.jsx("img",{src:C(n.data),alt:"icon",className:"h-8 w-8 rounded-full"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-300 leading-tight",children:n.data.name}),e.jsx("div",{className:"text-gray-400 text-xs leading-tight",children:"your personal account"})]})]}),a!=null&&a.success&&a.data.length?a.data.map(s=>e.jsxs("div",{className:b("py-2 flex space-x-2 items-center rounded px-3",s.has_channel_with_bot_access&&s.has_channel_with_user_access?"hover:bg-dark-3 cursor-pointer":"opacity-60 cursor-not-allowed"),role:"button",onClick:()=>s.has_channel_with_bot_access&&s.has_channel_with_user_access&&f(s.id),children:[e.jsx("img",{src:_(s),alt:"icon",className:"h-8 w-8 rounded-full"}),e.jsx("div",{className:"text-gray-300",children:s.name})]},s.id)):e.jsx("div",{className:"p-2 text-gray-300",children:"No servers found"})]})]})})}const W=h.object({messages:h.array(h.object({name:h.string(),description:h.string().nullable(),data:T}))}).or(h.object({backups:h.array(h.object({name:h.string(),messages:h.array(h.object({data:T}))}))}).transform(t=>({messages:t.backups.flatMap(r=>r.messages.map(n=>({name:r.name,description:null,data:n.data})))})));function K({messages:t,guildId:r}){const n=d.useRef(null),a=d.useRef(null),m=A(),l=k(s=>s.create),f=O();function i(s){if(s.target.files)for(let c=0;c<s.target.files.length;c++){const p=s.target.files[c],x=new FileReader;x.onload=y=>{var v;try{const j=JSON.parse((v=y.target)==null?void 0:v.result),o=W.safeParse(j);o.success?f.mutate({guildId:r,req:o.data},{onSuccess:()=>{m.invalidateQueries(["saved-messages",r])}}):(console.log(o.error),l({title:"Failed to import",message:"Data did not match the expected format",type:"error"}))}catch(j){l({title:"Failed to import",message:`Invalid JSON: ${j}`,type:"error"});return}},x.readAsText(p)}}function u(){const s={messages:t.map(x=>({name:x.name,description:x.description,data:x.data}))},c=JSON.stringify(s,null,2),p=window.URL.createObjectURL(new Blob([c],{type:"application/json"}));a.current&&(a.current.href=p,a.current.click())}return e.jsxs("div",{className:"flex space-x-3 justify-end flex-none",children:[e.jsxs("button",{className:"px-3 py-2 rounded text-white flex-none border-2 border-dark-7 hover:bg-dark-6",onClick:()=>{var s;return(s=n.current)==null?void 0:s.click()},children:["Import",e.jsx("input",{type:"file",className:"hidden",ref:n,accept:".json",multiple:!0,onChange:i})]}),e.jsxs("button",{className:"px-3 py-2 rounded text-white flex-none border-2 border-dark-7 hover:bg-dark-6",onClick:u,children:["Export All",e.jsx("a",{href:"",ref:a,download:"messages.json",className:"hidden"})]})]})}function X(t){return B(t).toLocaleString()}function Z({message:t,guildId:r}){const n=R(),a=k(o=>o.create),m=A(),l=F(),[f,i]=d.useState(!1);function u(){l.mutate({messageId:t.id,guildId:r,req:{name:t.name,description:t.description,data:M.getState()}},{onSuccess:o=>{o.success?(m.invalidateQueries(["saved-messages",r]),i(!1)):a({title:"Failed to update message",message:o.error.message,type:"error"})}})}const[s,c]=d.useState(!1);function p(){try{const o=Y(t.data);M.setState(o),c(!1),n("/editor")}catch(o){a({title:"Failed to restore message",message:`${o}`,type:"error"})}}const x=D(),[y,v]=d.useState(!1);function j(){x.mutate({messageId:t.id,guildId:r},{onSuccess:o=>{o.success?m.invalidateQueries(["saved-messages",r]):a({title:"Failed to delete message",message:o.error.message,type:"error"}),v(!1)}})}return e.jsxs("div",{children:[e.jsxs("div",{className:"bg-dark-3 p-3 rounded flex justify-between truncate space-x-3",children:[e.jsxs("div",{className:"flex-auto truncate",children:[e.jsxs("div",{className:"flex items-center space-x-1 truncate",children:[e.jsx("div",{className:"text-white truncate",children:t.name}),e.jsx("div",{className:"text-gray-500 text-xs hidden md:block",children:t.id})]}),e.jsx("div",{className:"text-gray-400 text-sm",children:X(t.updated_at)})]}),e.jsxs("div",{className:"flex flex-none items-center space-x-4 md:space-x-3",children:[e.jsxs("div",{className:"flex items-center text-gray-300 hover:text-white cursor-pointer md:bg-dark-2 md:rounded md:px-2 md:py-1",role:"button",onClick:()=>c(!0),children:[e.jsx(w,{text:"Restore Message",children:e.jsx(Q,{className:"h-5 w-5"})}),e.jsx("div",{className:"hidden md:block ml-2",children:"Restore"})]}),e.jsxs("div",{className:"flex items-center text-gray-300 hover:text-white cursor-pointer md:bg-dark-2 md:rounded md:px-2 md:py-1",role:"button",onClick:()=>i(!0),children:[e.jsx(w,{text:"Overwrite Message",children:e.jsx(q,{className:"h-5 w-5"})}),e.jsx("div",{className:"hidden md:block ml-2",children:"Overwrite"})]}),e.jsxs("div",{className:"flex items-center text-gray-300 hover:text-white cursor-pointer md:bg-dark-2 md:rounded md:px-2 md:py-1",role:"button",onClick:()=>v(!0),children:[e.jsx(w,{text:"Delete Message",children:e.jsx(L,{className:"h-5 w-5"})}),e.jsx("div",{className:"hidden md:block ml-2",children:"Delete"})]})]})]},t.id),s&&e.jsx(N,{title:"Are you sure that you want to restore the message?",subTitle:"The message data that you are currently working on in the editor will be replaced.",onClose:()=>c(!1),onConfirm:p}),f&&e.jsx(N,{title:"Are you sure that you want to update the message?",subTitle:"The message will be overwritten and the previous data will be lost.",onClose:()=>i(!1),onConfirm:u}),y&&e.jsx(N,{title:"Are you sure that you want to delete the message?",subTitle:"The message will be deleted permanently and can't be restored.",onClose:()=>v(!1),onConfirm:j})]})}function re(){var j,o;const t=G(g=>g.guildId),[r,n]=d.useState(null);d.useEffect(()=>{t&&n(t)},[t]);const{data:a}=I(),m=d.useMemo(()=>r==="user"?null:r,[r]),l=J(m),f=(j=l.data)!=null&&j.success?l.data.data.length:0,i=P(m),u=$(),s=(r==="user"?u==null?void 0:u.max_saved_messages:i==null?void 0:i.max_saved_messages)||0,[c,p]=d.useState(""),x=k(g=>g.create),y=z();function v(){if(f>=s){x({title:"Failed to save message",message:`You have reached the maximum number of saved messages (${s})`,type:"error"});return}c&&y.mutate({guildId:m,req:{name:c,description:"",data:M.getState()}},{onSuccess:g=>{g.success?(l.refetch(),p("")):x({title:"Failed to save message",message:g.error.message,type:"error"})}})}return e.jsx("div",{className:"overflow-y-auto w-full",children:e.jsxs("div",{className:"flex flex-col max-w-5xl mx-auto px-4 w-full my-5 lg:my-20",children:[e.jsxs("div",{className:"mb-10",children:[e.jsxs("div",{className:"flex space-x-4 items-center mb-3",children:[e.jsx("div",{className:"text-white text-2xl",children:"Saved Messages"}),e.jsxs("div",{className:"font-light italic text-gray-400",children:[f," / ",s]})]}),e.jsx("div",{className:"text-gray-400 font-light text-sm",children:"You can save the message that you are currently working on in the editor to continue working on it later. Saved Messages are stored in the cloud and can be accessed from any device."})]}),a!=null&&a.success?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"uppercase text-gray-300 text-sm font-medium mb-1.5",children:"Show Messages For"}),e.jsx("div",{className:"w-full max-w-md",children:e.jsx(H,{value:r,onChange:n})})]}),l.isSuccess&&l.data.success&&e.jsxs("div",{className:"space-y-5 mb-8",children:[l.data.data.map(g=>e.jsx(Z,{message:g,guildId:m},g.id)),l.data.data.length===0&&e.jsx("div",{className:"text-gray-400 font-light",children:'There are no saved messages yet. Enter a name below and click on "Save Message"'})]}),e.jsxs("div",{className:"flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3 items-end flex-none mb-5",children:[e.jsx(V,{label:"New Message Name",maxLength:25,value:c,onChange:p,className:"w-full"}),e.jsx("button",{className:b("px-3 py-2 rounded text-white flex-none",c?"bg-blurple hover:bg-blurple-dark":"bg-dark-2 cursor-not-allowed"),onClick:v,children:"Save Message"})]}),e.jsx(K,{guildId:m,messages:(o=l.data)!=null&&o.success?l.data.data:[]})]}):e.jsx("div",{className:"pb-10"})]})})}export{re as default};
